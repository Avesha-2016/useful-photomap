/*
	Source:
	van Creij, Maurice (2012). "useful.photomap.js: Plots the GPS data of the photos in a slideshow on a map", version 20120606, http://www.woollymittens.nl/.

	License:
	This work is licensed under a Creative Commons Attribution 3.0 Unported License.

	Prerequisites:
	<script src="http://www.photomap.org/openlayers/photomap.js"></script>
*/(function(useful){"use strict";var photomap={};photomap={start:function(e,t){photomap.busy.setup(t);photomap.gpx.load(t)},busy:{setup:function(e){return e},show:function(e){return e},hide:function(e){return e}},exif:{load:function(e,t){useful.request.send({url:t.exif.replace("{src}",e),post:null,onProgress:function(e){return e},onFailure:function(e){return e},onSuccess:function(e){photomap.exif.convert(useful.request.decode(e.responseText),t)}})},convert:function(e,t){var n,r,i;n=e.GPS.GPSLongitude[0].match(/\//)?parseInt(e.GPS.GPSLongitude[0].split("/")[0])/parseInt(e.GPS.GPSLongitude[0].split("/")[1]):parseInt(e.GPS.GPSLongitude[0]);r=e.GPS.GPSLongitude[1].match(/\//)?parseInt(e.GPS.GPSLongitude[1].split("/")[0])/parseInt(e.GPS.GPSLongitude[1].split("/")[1]):parseInt(e.GPS.GPSLongitude[1]);i=e.GPS.GPSLongitude[2].match(/\//)?parseInt(e.GPS.GPSLongitude[2].split("/")[0])/parseInt(e.GPS.GPSLongitude[2].split("/")[1]):parseInt(e.GPS.GPSLongitude[2]);t.indicator.lon=(n+r/60+i/3600)*(e.GPS.GPSLongitudeRef=="W"?-1:1);n=e.GPS.GPSLatitude[0].match(/\//)?parseInt(e.GPS.GPSLatitude[0].split("/")[0])/parseInt(e.GPS.GPSLatitude[0].split("/")[1]):parseInt(e.GPS.GPSLatitude[0]);r=e.GPS.GPSLatitude[1].match(/\//)?parseInt(e.GPS.GPSLatitude[1].split("/")[0])/parseInt(e.GPS.GPSLatitude[1].split("/")[1]):parseInt(e.GPS.GPSLatitude[1]);i=e.GPS.GPSLatitude[2].match(/\//)?parseInt(e.GPS.GPSLatitude[2].split("/")[0])/parseInt(e.GPS.GPSLatitude[2].split("/")[1]):parseInt(e.GPS.GPSLatitude[2]);t.indicator.lat=(n+r/60+i/3600)*(e.GPS.GPSLatitudeRef=="N"?1:-1);photomap.indicator.add(t)},unload:function(e){photomap.indicator.remove(e)}},gpx:{load:function(e){photomap.busy.show(e);useful.request.send({url:e.gpx,post:null,onProgress:function(e){return e},onFailure:function(e){return e},onSuccess:function(t){e.gpxDOM=t.responseXML;photomap.map.setup(e);photomap.route.plot(e);photomap.markers.add(e);photomap.indicator.add(e);e.balloon=e.balloon||{};photomap.busy.show(e)}})}},map:{setup:function(e){e.map={};e.map.object=new OpenLayers.Map("testmap",{controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.PanZoomBar,new OpenLayers.Control.LayerSwitcher,new OpenLayers.Control.Attribution],maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),maxResolution:156543.0399,numZoomLevels:19,units:"m",projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326")});var t=new OpenLayers.Layer.OSM.CycleMap("CycleMap");e.map.object.addLayer(t);var n=new OpenLayers.Layer.OSM.Mapnik("Mapnik");e.map.object.addLayer(n);photomap.map.centre(e);e.map.centre.lonLat=(new OpenLayers.LonLat(e.map.centre.lon,e.map.centre.lat)).transform(new OpenLayers.Projection("EPSG:4326"),e.map.object.getProjectionObject());e.map.object.setCenter(e.map.centre.lonLat,e.zoom)},centre:function(e){var t,n,r,i=0,s=0;e.map.centre=e.map.centre||{};r=e.gpxDOM.getElementsByTagName("trkpt");for(t=0,n=r.length;t<n;t+=1){i+=parseFloat(r[t].getAttribute("lat"));s+=parseFloat(r[t].getAttribute("lon"))}e.map.centre.lat=i/r.length;e.map.centre.lon=s/r.length}},route:{plot:function(e){var t=new OpenLayers.Layer.Vector("route",{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:e.gpx,format:new OpenLayers.Format.GPX}),style:{strokeColor:"blue",strokeWidth:5,strokeOpacity:.5},projection:new OpenLayers.Projection("EPSG:4326")});e.map.object.addLayer(t)}},markers:{add:function(e){var t,n,r,i;e.markers.object=new OpenLayers.Layer.Markers("Markers");e.trackPoints=e.gpxDOM.getElementsByTagName("trkpt");for(t in e.markers)if(e.markers.hasOwnProperty(t)&&t!=="object"){switch(t){case"start":e.markers[t].lat=e.trackPoints[0].getAttribute("lat");e.markers[t].lon=e.trackPoints[0].getAttribute("lon");break;case"end":e.markers[t].lat=e.trackPoints[e.trackPoints.length-1].getAttribute("lat");e.markers[t].lon=e.trackPoints[e.trackPoints.length-1].getAttribute("lon")}n=new OpenLayers.Size(32,32);r=new OpenLayers.Pixel(-(n.w/2),-n.h);i=new OpenLayers.Icon(e.markers[t].icon,n,r);e.markers[t].lonLat=(new OpenLayers.LonLat(e.markers[t].lon,e.markers[t].lat)).transform(new OpenLayers.Projection("EPSG:4326"),e.map.object.getProjectionObject());e.markers[t].object=new OpenLayers.Marker(e.markers[t].lonLat,i);photomap.markers.click(e.markers[t],e);e.markers.object.addMarker(e.markers[t].object)}e.map.object.addLayer(e.markers.object)},click:function(e,t){e.object.events.register("mousedown",e.object,function(n){t.balloon.description=e.description;t.balloon.lon=e.lon;t.balloon.lat=e.lat;photomap.balloon.add(t);OpenLayers.Event.stop(n)})}},indicator:{add:function(e){var t,n,r;if(e.indicator.lon&&e.indicator.lat){photomap.indicator.remove(e);t=new OpenLayers.Size(32,32);n=new OpenLayers.Pixel(-(t.w/2),-t.h);r=new OpenLayers.Icon(e.indicator.icon,t,n);e.indicator.lonLat=(new OpenLayers.LonLat(e.indicator.lon,e.indicator.lat)).transform(new OpenLayers.Projection("EPSG:4326"),e.map.object.getProjectionObject());e.indicator.object=new OpenLayers.Marker(e.indicator.lonLat,r);photomap.markers.click(e.indicator,e);e.markers.object.addMarker(e.indicator.object)}},remove:function(e){photomap.balloon.remove(e);if(e.indicator.object){e.markers.object.removeMarker(e.indicator.object);e.indicator.object.destroy();e.indicator.object=null}}},balloon:{add:function(e){photomap.balloon.remove(e);var t=(new OpenLayers.Geometry.Point(e.balloon.lon,e.balloon.lat)).transform("EPSG:4326","EPSG:3857"),n=new OpenLayers.Size(320,240);e.balloon.object=new OpenLayers.Popup.FramedCloud("Balloon",t.getBounds().getCenterLonLat(),n,e.balloon.description,null,!0);e.map.object.addPopup(e.balloon.object);e.balloon.object.show()},remove:function(e){if(e.balloon.object){e.balloon.object.destroy();e.balloon.object=null}}}};useful.request=useful.request||{};useful.request.send=function(e){var t;t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");t.onreadystatechange=function(){useful.request.update(t,e)};if(e.post){t.open("POST",e.url,!0);t.setRequestHeader("Content-type","application/x-www-form-urlencoded");t.setRequestHeader("Content-length",e.post.length);t.setRequestHeader("Connection","close");try{t.send(e.post)}catch(n){e.onFailure({readyState:-1,status:-1,statusText:n})}}else{t.open("GET",e.url,!0);try{t.send()}catch(n){e.onFailure({readyState:-1,status:-1,statusText:n})}}};useful.request.update=function(e,t){if(e.readyState===4)switch(e.status){case 200:t.onSuccess(e,t);break;case 304:t.onSuccess(e,t);break;default:t.onFailure(e,t)}else t.onProgress(e,t)};useful.request.decode=function(text){var object;object={};typeof jQuery!="undefined"?object=jQuery.parseJSON(text):typeof JSON!="undefined"&&typeof JSON.parse!="undefined"?object=JSON.parse(text):typeof jsonParse!="undefined"?object=jsonParse(text):eval("object = "+text);return object};useful.models=useful.models||{};useful.models.clone=function(e){var t,n;if(typeof Object.create!="undefined")t=Object.create(e);else{n=function(){};n.prototype=e;t=new n}return t};useful.models.trim=function(e){return e.replace(/^\s+|\s+$/g,"")};useful.css=useful.css||{};useful.css.select=function(e,t){var n,r,i;t=t||document;e=typeof e=="string"?{rule:e,parent:t}:e;e.parent=e.parent||document;e.data=e.data||{};i=typeof document.querySelectorAll!="undefined"?e.parent.querySelectorAll(e.rule):typeof jQuery!="undefined"?jQuery(e.parent).find(e.rule).get():[];if(typeof e.handler=="undefined")return i;for(n=0,r=i.length;n<r;n+=1)e.handler(i[n],useful.models.clone(e.data))};useful.photomap={};useful.photomap.start=photomap.start;useful.photomap.exif={};useful.photomap.exif.load=photomap.exif.load;useful.photomap.exif.unload=photomap.exif.unload})(window.useful=window.useful||{});